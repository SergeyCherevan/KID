---
name: Добавление свойств отслеживания нажатых кнопок мыши
overview: Добавление enum PressButtonStatus с флагами и двух свойств CurrentPressedButton и LastActualPressedButton для отслеживания состояния нажатых кнопок мыши на Canvas.
todos:
  - id: create_press_button_status
    content: "Создать PressButtonStatus.cs - enum с флагами [Flags]: NoButton (0b000), LeftButton (0b001), RightButton (0b010), OutOfArea (0b100)"
    status: pending
  - id: add_button_tracking_fields
    content: Добавить в Mouse.Click.cs приватные поля _currentPressedButton и _lastActualPressedButton (PressButtonStatus)
    status: pending
  - id: add_button_properties
    content: Добавить в Mouse.Click.cs свойства CurrentPressedButton и LastActualPressedButton с логикой вычисления
    status: pending
  - id: update_left_button_down
    content: Обновить OnMouseLeftButtonDown в Mouse.Click.cs - добавить LeftButton к _currentPressedButton
    status: pending
  - id: update_right_button_down
    content: Обновить OnMouseRightButtonDown в Mouse.Click.cs - добавить RightButton к _currentPressedButton
    status: pending
  - id: update_left_button_up
    content: Обновить OnMouseLeftButtonUp в Mouse.Click.cs - убрать LeftButton из _currentPressedButton
    status: pending
  - id: update_right_button_up
    content: Обновить OnMouseRightButtonUp в Mouse.Click.cs - убрать RightButton из _currentPressedButton
    status: pending
  - id: update_mouse_leave
    content: Обновить OnMouseLeave в Mouse.Position.cs - установить OutOfArea в _currentPressedButton, обновить _lastActualPressedButton
    status: pending
  - id: update_mouse_move
    content: Обновить OnMouseMove в Mouse.Position.cs - убрать OutOfArea из _currentPressedButton (если был), обновить _lastActualPressedButton
    status: pending
---

# План добавления свойств отслеживания нажатых кнопок мыши

## 1. Анализ требований

### Описание функции
Добавление двух новых свойств в класс Mouse для отслеживания состояния нажатых кнопок мыши:
- `CurrentPressedButton` - текущее состояние нажатых кнопок (может включать OutOfArea если курсор вне Canvas)
- `LastActualPressedButton` - последнее состояние нажатых кнопок, когда курсор был на Canvas

### Целевая аудитория
Начинающие программисты, которым нужно отслеживать состояние нажатых кнопок мыши для интерактивных приложений.

### Сценарии использования
- Отслеживание зажатых кнопок мыши для drag-and-drop операций
- Определение, какая кнопка нажата в данный момент
- Реакция на комбинации нажатых кнопок (левая + правая одновременно)

## 2. Архитектурный анализ

### Затронутые подсистемы
- **KID.Library/Mouse** - добавление нового enum и свойств

### Новые компоненты
1. **PressButtonStatus.cs** - enum с флагами для состояния кнопок мыши

### Изменяемые компоненты
1. **Mouse.Click.cs** - добавление отслеживания состояния нажатых кнопок
2. **Mouse.Position.cs** - обновление LastActualPressedButton при выходе курсора за пределы Canvas

### Зависимости
- Существующие обработчики событий MouseLeftButtonDown, MouseRightButtonDown, MouseLeftButtonUp, MouseRightButtonUp
- Обработчик MouseLeave для установки OutOfArea

## 3. Структура файлов

### Новые файлы в `KID.Library/Mouse/`:
1. **PressButtonStatus.cs** - enum с флагами [Flags]

### Изменяемые файлы:
1. **Mouse.Click.cs** - добавление отслеживания состояния кнопок и свойств CurrentPressedButton, LastActualPressedButton
2. **Mouse.Position.cs** - обновление LastActualPressedButton в OnMouseLeave

## 4. Детальная реализация

### 4.1. PressButtonStatus.cs

```csharp
using System;

namespace KID
{
    /// <summary>
    /// Статус нажатых кнопок мыши (флаги).
    /// </summary>
    [Flags]
    public enum PressButtonStatus
    {
        /// <summary>
        /// Нет нажатых кнопок.
        /// </summary>
        NoButton = 0b000,
        
        /// <summary>
        /// Нажата левая кнопка мыши.
        /// </summary>
        LeftButton = 0b001,
        
        /// <summary>
        /// Нажата правая кнопка мыши.
        /// </summary>
        RightButton = 0b010,
        
        /// <summary>
        /// Курсор находится вне Canvas.
        /// </summary>
        OutOfArea = 0b100
    }
}
```

### 4.2. Mouse.Click.cs

Добавить:
- Приватное поле `_currentPressedButton` (PressButtonStatus) для отслеживания текущего состояния
- Приватное поле `_lastActualPressedButton` (PressButtonStatus) для последнего состояния на Canvas
- Свойство `CurrentPressedButton` - вычисляемое на основе _currentPressedButton и позиции курсора
- Свойство `LastActualPressedButton` - возвращает _lastActualPressedButton
- Обновление состояния в OnMouseLeftButtonDown (добавить LeftButton)
- Обновление состояния в OnMouseRightButtonDown (добавить RightButton)
- Обновление состояния в OnMouseLeftButtonUp (убрать LeftButton)
- Обновление состояния в OnMouseRightButtonUp (убрать RightButton)

### 4.3. Mouse.Position.cs

Обновить `OnMouseLeave`:
- Установить OutOfArea в _currentPressedButton (сохраняя флаги нажатых кнопок)
- Обновить _lastActualPressedButton перед установкой OutOfArea (если курсор был на Canvas)

Обновить `OnMouseMove`:
- Убрать OutOfArea из _currentPressedButton (если был установлен)
- Обновить _lastActualPressedButton текущим состоянием (без OutOfArea)

## 5. Технические детали

### Логика CurrentPressedButton
- Вычисляется динамически на основе:
  - Состояния нажатых кнопок (_currentPressedButton без OutOfArea)
  - Позиции курсора (если вне Canvas, добавляется OutOfArea)
- Если курсор на Canvas: возвращает только флаги кнопок
- Если курсор вне Canvas: возвращает OutOfArea | флаги нажатых кнопок

### Логика LastActualPressedButton
- Сохраняет последнее состояние, когда курсор был на Canvas
- Обновляется в OnMouseMove (если курсор на Canvas)
- Обновляется в OnMouseLeave (перед установкой OutOfArea)
- Никогда не содержит флаг OutOfArea

### Обработка событий
- MouseLeftButtonDown: добавить LeftButton к _currentPressedButton
- MouseRightButtonDown: добавить RightButton к _currentPressedButton
- MouseLeftButtonUp: убрать LeftButton из _currentPressedButton
- MouseRightButtonUp: убрать RightButton из _currentPressedButton
- MouseLeave: добавить OutOfArea к _currentPressedButton (сохраняя флаги кнопок), обновить _lastActualPressedButton
- MouseMove: убрать OutOfArea из _currentPressedButton (если был), обновить _lastActualPressedButton

### Потокобезопасность
- Все обновления через InvokeOnUI()
- Свойства возвращают значения через InvokeOnUI()

## 6. Порядок выполнения задач

1. Создать `PressButtonStatus.cs` - enum с флагами
2. Обновить `Mouse.Click.cs` - добавить поля и свойства для отслеживания состояния
3. Обновить обработчики в `Mouse.Click.cs` - отслеживание нажатия/отпускания кнопок
4. Обновить `Mouse.Position.cs` - обработка OutOfArea в OnMouseLeave и OnMouseMove

## 7. Оценка сложности

### Задача 1: Создание PressButtonStatus.cs
- **Сложность:** Низкая
- **Время:** 10-15 минут
- **Риски:** Минимальные

### Задача 2: Добавление свойств и полей в Mouse.Click.cs
- **Сложность:** Низкая
- **Время:** 15-20 минут
- **Риски:** Правильная инициализация полей

### Задача 3: Обновление обработчиков событий
- **Сложность:** Средняя
- **Время:** 20-30 минут
- **Риски:** Корректная обработка комбинаций флагов, синхронизация состояния

### Задача 4: Обновление Mouse.Position.cs
- **Сложность:** Низкая
- **Время:** 10-15 минут
- **Риски:** Правильная обработка OutOfArea флага

**Общая оценка:** 55-80 минут

## 8. Потенциальные проблемы и решения

### Проблема 1: Состояние кнопок при выходе курсора за пределы Canvas
**Решение:** Сохранять флаги нажатых кнопок при установке OutOfArea, обновлять LastActualPressedButton перед установкой OutOfArea

### Проблема 2: Синхронизация состояния при быстром нажатии/отпускании
**Решение:** Все обновления в UI потоке, использование InvokeOnUI для свойств

### Проблема 3: Комбинации флагов
**Решение:** Использовать битовые операции для установки/сброса флагов

## 9. Примеры использования (для документации)

```csharp
using System;
using KID;

// Проверка нажатой кнопки
if ((Mouse.CurrentPressedButton & PressButtonStatus.LeftButton) != 0)
{
    Console.WriteLine("Левая кнопка нажата");
}

// Проверка комбинации кнопок
if (Mouse.CurrentPressedButton == (PressButtonStatus.LeftButton | PressButtonStatus.RightButton))
{
    Console.WriteLine("Обе кнопки нажаты одновременно");
}

// Проверка, находится ли курсор на Canvas
if ((Mouse.CurrentPressedButton & PressButtonStatus.OutOfArea) == 0)
{
    Console.WriteLine("Курсор на Canvas");
}

// Получение последнего состояния на Canvas
var lastState = Mouse.LastActualPressedButton;
```