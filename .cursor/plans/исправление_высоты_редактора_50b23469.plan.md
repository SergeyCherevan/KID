---
name: Исправление высоты редактора
overview: "AvalonEdit в CodeEditorsView имеет высоту по контенту вместо максимальной доступной из‑за того, что ItemsControl по умолчанию использует StackPanel, который выделяет дочерним элементам их DesiredSize по направлению стека. План предлагает два варианта решения: замена на ContentControl (рекомендуется) или смена ItemsPanel на Grid."
todos: []
isProject: false
---

# Исправление высоты AvalonEdit в CodeEditorsView

## 1. Анализ проблемы

### Причина

Цепочка контейнеров:

```
MainWindow Grid (Row 2: Height="*")
  → WorkspaceGrid (Column 0: Width="*")
    → CodeEditorsView
      → Grid (Row 1: Height="*")
        → ItemsControl (Margin="5")
          → [по умолчанию] StackPanel (вертикальный)
            → ContentControl (для каждого OpenedFile)
              → TextEditor (CodeEditor)
```

ItemsControl по умолчанию использует StackPanel как ItemsPanel. В вертикальном StackPanel дочерние элементы получают по вертикали свою DesiredSize (их естественный размер), а не доступное пространство. AvalonEdit TextEditor сообщает DesiredSize по количеству строк (число строк × высота строки), поэтому высота редактора ограничивается контентом, а не областью родителя.

### Подтверждение

- [MS Docs](https://learn.microsoft.com/en-us/dotnet/api/system.windows.controls.itemscontrol.itemspanel): ItemsControl по умолчанию использует StackPanel.
- [StackOverflow](https://stackoverflow.com/questions/22741578/itemscontrol-is-preventing-item-content-from-expanding-to-fill-its-container): в вертикальном StackPanel элементы принимают желаемую высоту, а не растягиваются.

---

## 2. Варианты решения

### Вариант A: ContentControl вместо ItemsControl (рекомендуется)

Семантика: отображается только активная вкладка; это соответствует текущей логике (только один редактор виден).

**Изменения в [CodeEditorsView.xaml](KID.WPF.IDE/Views/CodeEditorsView.xaml):**

```xml
<!-- Было -->
<ItemsControl Grid.Row="1" ItemsSource="{Binding OpenedFiles}" Margin="5">
    <ItemsControl.ItemTemplate>
        <DataTemplate>
            <ContentControl Content="{Binding CodeEditor}"
                            Visibility="{Binding IsActive, ...}"/>
        </DataTemplate>
    </ItemsControl.ItemTemplate>
</ItemsControl>

<!-- Стало -->
<ContentControl Grid.Row="1"
               Content="{Binding ActiveFile}"
               Margin="5">
    <ContentControl.ContentTemplate>
        <DataTemplate DataType="{x:Type models:OpenedFileTab}">
            <ContentPresenter Content="{Binding CodeEditor}"
                               HorizontalAlignment="Stretch"
                               VerticalAlignment="Stretch"/>
        </DataTemplate>
    </ContentControl.ContentTemplate>
</ContentControl>
```

Добавить `xmlns:models` в корневой элемент, если его ещё нет.

**Плюсы:** простой вариант, ContentControl растягивается по Grid с Height="*", без изменений во ViewModel.  
**Минусы:** нет.

---

### Вариант B: замена ItemsPanel на Grid

Сохраняем ItemsControl, но меняем панель так, чтобы все элементы располагались в одной ячейке и получали её размер.

**Изменения в [CodeEditorsView.xaml](KID.WPF.IDE/Views/CodeEditorsView.xaml):**

```xml
<ItemsControl Grid.Row="1"
              ItemsSource="{Binding OpenedFiles}"
              Margin="5">
    <ItemsControl.ItemsPanel>
        <ItemsPanelTemplate>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
            </Grid>
        </ItemsPanelTemplate>
    </ItemsControl.ItemsPanel>
    <ItemsControl.ItemTemplate>
        <DataTemplate>
            <ContentControl Content="{Binding CodeEditor}"
                            Visibility="{Binding IsActive, ...}"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"/>
        </DataTemplate>
    </ItemsControl.ItemTemplate>
</ItemsControl>
```

**Плюсы:** сохранение текущей структуры с ItemsControl.  
**Минусы:** Grid с одной строкой, все элементы в одной ячейке — менее очевидная семантика, чем ContentControl.

---

## 3. Рекомендация

Предпочтителен **вариант A**: он лучше отражает модель «один активный редактор» и проще в поддержке.

---

## 4. Задачи

| # | Задача | Сложность | Оценка |
|---|--------|-----------|--------|
| 1 | Проверить наличие `xmlns:models` в CodeEditorsView.xaml | Низкая | 1 мин |
| 2 | Заменить ItemsControl на ContentControl с Content="{Binding ActiveFile}" и DataTemplate для OpenedFileTab (вариант A) | Низкая | 5 мин |
| 3 | Запуск приложения и проверка растяжения редактора по высоте | Низкая | 2 мин |

---

## 5. Альтернатива (вариант B)

Если нужен именно ItemsControl:

- Добавить `ItemsControl.ItemsPanel` с Grid и одной строкой Height="*".
- Для ContentControl установить `HorizontalAlignment="Stretch"` и `VerticalAlignment="Stretch"`.

---

## 6. Риски

- При ContentControl необходимо убедиться, что `ActiveFile` не null. В текущей реализации `CloseFile` всегда вызывает `AddFile(NewFilePath, ...)` при пустом списке, поэтому активная вкладка всегда есть.
- Локализация и документация не затрагиваются.
