---
name: Рефакторинг системы редакторов
overview: Переименование View/ViewModel, замена ContentControl на список редакторов с Visibility по индексу, создание CodeEditor в AddFile() и удаление в CloseFile().
todos: []
isProject: false
---

# Рефакторинг системы редакторов кода

## 1. Анализ требований

### Описание

- Переименовать CodeEditorView → CodeEditorsView, CodeEditorViewModel → CodeEditorsViewModel
- Переименовать свойство TextEditor → CodeEditor (в OpenedFileTab, ViewModel, интерфейсе)
- Заменить архитектуру «один ContentControl» на «список AvalonEdit TextEditor»: все редакторы в списке, виден только активный (по indexOfActiveFile)
- AddFile(): создавать OpenedFileTab с новым CodeEditor (new TextEditor()), добавлять в OpenedFiles
- CloseFile(): удалять вкладку из OpenedFiles (CodeEditor уйдёт вместе с ней из визуального дерева)

### Важно

- Класс AvalonEdit остаётся `TextEditor` (ICSharpCode.AvalonEdit) — переименовываем только наши свойства/алиасы в `CodeEditor`
- EditorTabContent больше не нужен — CodeEditor создаётся в ViewModel и отображается напрямую

---

## 2. Архитектурный анализ

### Затрагиваемые подсистемы

- ViewModels: CodeEditorViewModel → CodeEditorsViewModel
- Views: CodeEditorView → CodeEditorsView
- Models: OpenedFileTab (TextEditor → CodeEditor)
- Interfaces: ICodeEditorViewModel → ICodeEditorsViewModel
- DI, MainWindow, MenuViewModel, WindowInitializationService, App.xaml.cs

### Удаляемые компоненты

- `[EditorTabContent.xaml](KID.WPF.IDE/Views/EditorTabContent.xaml)`
- `[EditorTabContent.xaml.cs](KID.WPF.IDE/Views/EditorTabContent.xaml.cs)`

### Схема после рефакторинга

```
CodeEditorsViewModel
    OpenedFiles: ObservableCollection<OpenedFileTab>
    indexOfActiveFile: int
    ActiveFile => OpenedFiles[indexOfActiveFile]
    
OpenedFileTab
    FilePath, Content
    CodeEditor: TextEditor  // создаётся в AddFile(), присваивается в tab
    
AddFile(path, content):
    tab = new OpenedFileTab { FilePath, Content, CodeEditor = new TextEditor() }
    OpenedFiles.Add(tab)
    
CloseFile(tab):
    OpenedFiles.Remove(tab)  // CodeEditor уходит с визуальным деревом
```

---

## 3. Список задач

### 3.1 Переименование файлов и классов


| Было                    | Стало                    |
| ----------------------- | ------------------------ |
| CodeEditorView.xaml     | CodeEditorsView.xaml     |
| CodeEditorView.xaml.cs  | CodeEditorsView.xaml.cs  |
| CodeEditorViewModel.cs  | CodeEditorsViewModel.cs  |
| ICodeEditorViewModel.cs | ICodeEditorsViewModel.cs |


### 3.2 Изменение OpenedFileTab

- Переименовать `TextEditor` → `CodeEditor`
- `Content` можно оставить как fallback или убрать — текст будет храниться в `CodeEditor.Text`

### 3.3 Изменение CodeEditorsViewModel

- В `AddFile()`: создавать `new TextEditor()`, настраивать (ShowLineNumbers, WordWrap, фон/foreground), задавать `Text = content`, присваивать в `tab.CodeEditor`
- В `CloseFile()`: удалять вкладку из `OpenedFiles`; при закрытии последней — вызывать `AddFile(NewFilePath, "")`
- Свойство `TextEditor` → `CodeEditor` (делегирует в `ActiveFile?.CodeEditor`)
- Все обращения к `ActiveFile?.TextEditor` заменить на `ActiveFile?.CodeEditor`

### 3.4 Изменение ICodeEditorsViewModel

- `TextEditor` → `CodeEditor`
- `ICodeEditorViewModel` → `ICodeEditorsViewModel`

### 3.5 Изменение CodeEditorsView.xaml

- Заменить `<Список из avalonedit:TextEditor'ов />` на:

```xml
<ItemsControl ItemsSource="{Binding OpenedFiles}" Grid.Row="1">
    <ItemsControl.ItemsPanel>
        <ItemsPanelTemplate>
            <Grid/>
        </ItemsPanelTemplate>
    </ItemsControl.ItemsPanel>
    <ItemsControl.ItemTemplate>
        <DataTemplate>
            <ContentControl Content="{Binding CodeEditor}"
                            Visibility="{Binding IsActive, Converter={StaticResource BoolToVisibilityConverter}}"/>
        </DataTemplate>
    </ItemsControl.ItemTemplate>
</ItemsControl>
```

- Для Visibility нужен `IsActive` в OpenedFileTab или привязка к индексу. Проще добавить `IsActive` в OpenedFileTab и обновлять при смене ActiveFile.

### 3.6 Альтернатива: привязка Visibility по индексу

- Добавить конвертер `IndexToVisibilityConverter`, принимающий (indexOfActiveFile, currentIndex)
- Использовать `ItemsControl.AlternationIndex` или передавать индекс через конвертер

Рекомендация: добавить `IsActive` в OpenedFileTab — меньше зависимостей от индекса и проще логика.

### 3.7 Обновление ссылок

- MainWindow.xaml: `CodeEditorView` → `CodeEditorsView`
- ServiceCollectionExtensions: `ICodeEditorViewModel` → `ICodeEditorsViewModel`, `CodeEditorViewModel` → `CodeEditorsViewModel`
- MenuViewModel: тип зависимости
- WindowInitializationService: тип зависимости
- App.xaml.cs: `ICodeEditorViewModel` → `ICodeEditorsViewModel`
- DataContext в CodeEditorsView: `ICodeEditorsViewModel`

### 3.8 Удаление EditorTabContent

- Удалить EditorTabContent.xaml и EditorTabContent.xaml.cs
- Удалить DataTemplate для OpenedFileTab из Resources (если использовался EditorTabContent)

---

## 4. Порядок выполнения

1. Добавить `IsActive` в OpenedFileTab
2. Создать BoolToVisibilityConverter (если его нет)
3. Переименовать TextEditor → CodeEditor в OpenedFileTab
4. Реализовать AddFile() и CloseFile() в CodeEditorsViewModel
5. Переименовать CodeEditorViewModel → CodeEditorsViewModel, обновить логику
6. Переименовать ICodeEditorViewModel → ICodeEditorsViewModel
7. Переименовать CodeEditorView → CodeEditorsView, обновить XAML (список редакторов)
8. Обновить DI и ссылки (MainWindow, MenuViewModel, WindowInitializationService, App)
9. Удалить EditorTabContent
10. Проверить компиляцию и базовый сценарий

---

## 5. Оценка сложности


| Задача                               | Сложность | Время  | Риски                       |
| ------------------------------------ | --------- | ------ | --------------------------- |
| OpenedFileTab (IsActive, CodeEditor) | Низкая    | 15 мин | —                           |
| AddFile/CloseFile                    | Средняя   | 30 мин | Настройка TextEditor в коде |
| Переименование ViewModel/View        | Низкая    | 20 мин | Много файлов                |
| XAML списка редакторов               | Средняя   | 25 мин | Visibility, layout          |
| Обновление ссылок                    | Низкая    | 15 мин | Пропуск ссылки              |
| Удаление EditorTabContent            | Низкая    | 5 мин  | —                           |


---

## 6. Важные детали

### 6.1 Создание TextEditor в AddFile()

```csharp
var codeEditor = new TextEditor
{
    ShowLineNumbers = true,
    WordWrap = true,
    Text = content
};
// Background/Foreground — через стили или применить после добавления в визуальное дерево
```

### 6.2 Layout редакторов

Все редакторы должны занимать одну и ту же область (под панелью вкладок). Варианты:

- **Вариант A:** ItemsControl с Grid как ItemsPanel; все дети в одной ячейке (0,0), Visibility скрывает неактивные
- **Вариант B:** Единый Grid с одной ячейкой, внутри ItemsControl без StackPanel; каждый Item — ContentControl с CodeEditor

Для варианта A нужен кастомный panel или обёртка. Проще: обернуть ItemsControl в Grid, использовать `ItemsPanelTemplate` с `Grid` с одной строкой/столбцом, и позиционировать элементы через Margin или через общий родитель.

Практичный вариант: `ItemsControl` с дефолтным `StackPanel`, каждый item — `ContentControl` с `Content="{Binding CodeEditor}"` и `Visibility="{Binding IsActive, Converter=...}"`. Collapsed-элементы не занимают места, один видимый редактор заполняет высоту.

### 6.3 Обновление IsActive

При смене `ActiveFile` обновить `IsActive` у всех вкладок:

```csharp
foreach (var tab in OpenedFiles)
    tab.IsActive = (tab == value);
```

---

## 7. Файлы для изменения

- [OpenedFileTab.cs](KID.WPF.IDE/Models/OpenedFileTab.cs)
- [CodeEditorViewModel.cs](KID.WPF.IDE/ViewModels/CodeEditorViewModel.cs) → CodeEditorsViewModel.cs
- [ICodeEditorViewModel.cs](KID.WPF.IDE/ViewModels/Interfaces/ICodeEditorViewModel.cs) → ICodeEditorsViewModel.cs
- [CodeEditorView.xaml](KID.WPF.IDE/Views/CodeEditorView.xaml) → CodeEditorsView.xaml
- [CodeEditorView.xaml.cs](KID.WPF.IDE/Views/CodeEditorView.xaml.cs) → CodeEditorsView.xaml.cs
- [MainWindow.xaml](KID.WPF.IDE/MainWindow.xaml)
- [ServiceCollectionExtensions.cs](KID.WPF.IDE/Services/DI/ServiceCollectionExtensions.cs)
- [MenuViewModel.cs](KID.WPF.IDE/ViewModels/MenuViewModel.cs)
- [WindowInitializationService.cs](KID.WPF.IDE/Services/Initialize/WindowInitializationService.cs)
- [App.xaml.cs](KID.WPF.IDE/App.xaml.cs)

